name: "ü§ñ Auto-Heal Infrastructure"

on:
  repository_dispatch:
    types: [grafana-alert, manual-remediation]

jobs:
  analyze-alert:
    name: "Analyze Alert & Remediate"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          ref: main
          
      - name: "Install yq (YAML processor)"
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          
      - name: "Parse Alert Payload"
        id: alert
        run: |
          ALERT_NAME="${{ github.event.client_payload.alert_name }}"
          POD_NAME="${{ github.event.client_payload.labels.pod }}"
          NAMESPACE="${{ github.event.client_payload.labels.namespace }}"
          
          echo "alert_name=$ALERT_NAME" >> $GITHUB_OUTPUT
          echo "pod=$POD_NAME" >> $GITHUB_OUTPUT
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT
          
          echo "üö® Alert received: $ALERT_NAME for pod $POD_NAME in $NAMESPACE"
          
      - name: "Apply Remediation Logic"
        id: remediate
        run: |
          ALERT="${{ steps.alert.outputs.alert_name }}"
          
          case "$ALERT" in
            "HighMemoryUsage")
              echo "üìä Increasing memory limit by 50%"
              yq eval '.spec.template.spec.containers[0].resources.limits.memory = "150Mi"' \
                -i k8s-app/guestbook.yaml
              echo "action=Increased memory to 150Mi" >> $GITHUB_OUTPUT
              ;;
              
            "HighCPUUsage")
              echo "‚ö° Scaling up replicas"
              yq eval '.spec.replicas = 5' -i k8s-app/guestbook.yaml
              echo "action=Scaled to 5 replicas" >> $GITHUB_OUTPUT
              ;;
              
            "PodCrashLoop")
              echo "üîÑ Rolling back to previous version"
              yq eval '.spec.template.spec.containers[0].image = "nginx:1.25-alpine"' \
                -i k8s-app/guestbook.yaml
              echo "action=Rolled back to nginx:1.25-alpine" >> $GITHUB_OUTPUT
              ;;
              
            *)
              echo "::error::Unknown alert type: $ALERT"
              echo "action=No remediation available" >> $GITHUB_OUTPUT
              exit 1
              ;;
          esac
          
      - name: "Verify YAML Syntax"
        run: |
          # Basic syntax check without cluster connection
          yq eval '.' k8s-app/guestbook.yaml > /dev/null
          yq eval '.' k8s-app/monitoring.yaml > /dev/null
          echo "‚úÖ YAML syntax valid"
          
      - name: "Commit Changes to Git"
        run: |
          git config user.name "eagle-eye-bot"
          git config user.email "eagle-eye-bot@noreply.github.com"
          
          git add k8s-app/
          git commit -m "Auto-remediation: ${{ steps.remediate.outputs.action }}" \
            -m "Alert: ${{ steps.alert.outputs.alert_name }}" \
            -m "Pod: ${{ steps.alert.outputs.pod }}" \
            -m "Namespace: ${{ steps.alert.outputs.namespace }}"
          
          git push origin main
          
      - name: "Summary"
        run: |
          echo "‚úÖ Remediation applied and committed to git"
          echo "‚è≥ ArgoCD will sync changes within 3 minutes"
          echo ""
          echo "üìù Summary:"
          echo "  Alert: ${{ steps.alert.outputs.alert_name }}"
          echo "  Action: ${{ steps.remediate.outputs.action }}"
          echo "  Commit: $(git rev-parse HEAD)"
